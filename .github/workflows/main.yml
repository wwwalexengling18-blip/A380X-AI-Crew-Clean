name: Build Setup EXE

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Detect project root
        shell: cmd
        run: |
          @echo off
          set "PROJ=."
          if exist "tools\run_ai.py" set "PROJ=."
          if exist "FBW_A380X_AI_Crew_Phase1-8_Starter\tools\run_ai.py" set "PROJ=FBW_A380X_AI_Crew_Phase1-8_Starter"
          if exist "FBW_A380X_AI_Crew_Project\tools\run_ai.py" set "PROJ=FBW_A380X_AI_Crew_Project"
          echo PROJ=%PROJ%>> %GITHUB_ENV%
          echo Detected PROJ=%PROJ%

      - name: Install dependencies
        shell: cmd
        run: |
          @echo off
          python -m pip install --upgrade pip
          if exist "%PROJ%\requirements.txt" (
            pip install -r "%PROJ%\requirements.txt"
          ) else (
            echo No requirements.txt found in %PROJ%
          )
          pip install pyinstaller

      - name: Build portable EXE (PyInstaller)
        shell: cmd
        run: |
          @echo off
          if not exist "%PROJ%\tools\run_ai.py" (
            echo ERROR: %PROJ%\tools\run_ai.py not found
            dir
            exit /b 1
          )
          pyinstaller --onefile --name A380X_AI --distpath "%PROJ%\dist" "%PROJ%\tools\run_ai.py"

      - name: Install Inno Setup
        shell: cmd
        run: |
          @echo off
          choco install innosetup -y --no-progress

      - name: Build installer (Inno Setup)
        shell: cmd
        run: |
          @echo off
          set "ISS="
          if exist "%PROJ%\installer\A380X_AI_Setup.iss" set "ISS=%PROJ%\installer\A380X_AI_Setup.iss"
          if exist "%PROJ%\Installateur\A380X_AI_Setup.iss" set "ISS=%PROJ%\Installateur\A380X_AI_Setup.iss"
          if "%ISS%"=="" (
            echo ERROR: No .iss found in %PROJ%\installer or %PROJ%\Installateur
            dir "%PROJ%"
            exit /b 1
          )
          echo Using ISS=%ISS%
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "%ISS%"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: A380X_AI_Build
          path: |
            **/dist/**
            **/Installateur/Output/**
            **/installer/Output/**
